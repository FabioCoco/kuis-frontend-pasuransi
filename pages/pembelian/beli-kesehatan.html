<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beli Asuransi Kesehatan - Pasuransi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="../home.html" class="logo">Pasuransi</a>
                <div class="nav-links" id="navLinks"></div>
            </nav>
        </div>
    </header>

    <main>
        <section class="purchase-header health">
            <div class="container">
                <h1>Formulir Asuransi Kesehatan</h1>
                <p>Lengkapi data diri Anda untuk menghitung premi.</p>
            </div>
        </section>

        <section class="purchase-form-section">
            <div class="container form-grid">
                <div class="purchase-form">
                    <h2>Data Diri Calon Tertanggung</h2>
                    <form id="purchaseForm" novalidate>
                        <div class="form-row">
                            <div class="input-group">
                                <label for="fullName">Nama Lengkap (sesuai KTP)</label>
                                <input type="text" id="fullName" required>
                            </div>
                            <div class="input-group">
                                <label for="dob">Tanggal Lahir</label>
                                <input type="date" id="dob" required>
                            </div>
                        </div>
                        <div class="input-group full-width">
                            <label for="pekerjaan">Pekerjaan</label>
                            <input type="text" id="pekerjaan" required>
                        </div>
                        
                        <!-- Komponen Multi-Select Dropdown Baru -->
                        <div class="input-group full-width">
                            <label for="conditionSearch">Kondisi Kesehatan (pilih jika ada)</label>
                            <div class="multi-select-container" id="multiSelectContainer">
                                <div class="selected-items" id="selectedItems">
                                    <!-- Tag yang dipilih akan muncul di sini -->
                                </div>
                                <input type="text" id="conditionSearch" placeholder="Cari kondisi kesehatan...">
                                <div class="dropdown-list" id="dropdownList">
                                    <!-- Pilihan akan di-generate oleh JS -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="formMessage" class="message"></div>
                        <button type="submit" class="btn btn-full">Hitung Premi</button>
                    </form>
                </div>

                <aside class="premium-summary">
                    <h3>Ringkasan Premi</h3>
                    <div class="price-display" id="premiumDisplay">
                        <p>Premi Anda akan ditampilkan di sini setelah Anda melengkapi formulir dan menekan tombol hitung.</p>
                    </div>
                    <div class="payment-method">
                        <h4>Pilih Metode Pembayaran</h4>
                        <div class="payment-option">
                            <input type="radio" id="bca" name="payment" value="BCA Virtual Account" checked>
                            <label for="bca">BCA Virtual Account</label>
                        </div>
                        <div class="payment-option">
                            <input type="radio" id="gopay" name="payment" value="GoPay">
                            <label for="gopay">GoPay</label>
                        </div>
                    </div>
                    <button id="payBtn" class="btn btn-full disabled">Bayar Sekarang</button>
                </aside>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Pasuransi. Semua hak dilindungi.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Bagian Navbar & Cek Login (Sama seperti sebelumnya) ---
            const navLinksContainer = document.getElementById('navLinks');
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                window.location.href = '/pages/login.html';
                return;
            }
            navLinksContainer.innerHTML = `
                <span>Halo, <strong>${loggedInUser.fullName.split(' ')[0]}</strong>!</span>
                <a href="/pages/home.html">Home</a>
                <a href="/pages/histori/histori.html">Histori</a>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            `;
            document.getElementById('logoutBtn').addEventListener('click', function() {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = '/pages/login.html';
            });

            // --- Logika Multi-Select Dropdown ---
            const conditions = [
                { name: 'Perokok', factor: 0.5 },
                { name: 'Riwayat Hipertensi', factor: 0.4 },
                { name: 'Diabetes', factor: 0.5 },
                { name: 'Penyakit Jantung', factor: 0.6 },
                { name: 'Asma', factor: 0.3 },
                { name: 'Kolesterol Tinggi', factor: 0.35 }
            ];

            let availableConditions = [...conditions];
            let selectedConditions = [];

            const searchInput = document.getElementById('conditionSearch');
            const dropdown = document.getElementById('dropdownList');
            const selectedItemsContainer = document.getElementById('selectedItems');
            const multiSelectContainer = document.getElementById('multiSelectContainer');

            function renderDropdown() {
                dropdown.innerHTML = '';
                const filter = searchInput.value.toLowerCase();
                const filteredConditions = availableConditions.filter(c => c.name.toLowerCase().includes(filter));

                filteredConditions.forEach(condition => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = condition.name;
                    item.dataset.name = condition.name;
                    dropdown.appendChild(item);
                });
            }

            function addCondition(name) {
                const condition = conditions.find(c => c.name === name);
                if (!condition) return;

                selectedConditions.push(condition);
                availableConditions = availableConditions.filter(c => c.name !== name);
                
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    <span>${condition.name}</span>
                    <button class="remove-tag" data-name="${condition.name}">&times;</button>
                `;
                selectedItemsContainer.appendChild(tag);
                
                searchInput.value = '';
                renderDropdown();
                dropdown.classList.remove('show');
            }

            function removeCondition(name) {
                const condition = conditions.find(c => c.name === name);
                if (!condition) return;

                selectedConditions = selectedConditions.filter(c => c.name !== name);
                availableConditions.push(condition);
                
                const tagToRemove = selectedItemsContainer.querySelector(`.remove-tag[data-name="${name}"]`).parentElement;
                selectedItemsContainer.removeChild(tagToRemove);
                
                renderDropdown();
            }

            searchInput.addEventListener('input', renderDropdown);
            searchInput.addEventListener('focus', () => {
                dropdown.classList.add('show');
                renderDropdown();
            });

            document.addEventListener('click', function(e) {
                if (!multiSelectContainer.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            dropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-item')) {
                    addCondition(e.target.dataset.name);
                }
            });

            selectedItemsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-tag')) {
                    removeCondition(e.target.dataset.name);
                }
            });

            // --- Logika Form & Perhitungan Premi ---
            const form = document.getElementById('purchaseForm');
            const premiumDisplay = document.getElementById('premiumDisplay');
            const payBtn = document.getElementById('payBtn');
            const formMessage = document.getElementById('formMessage');

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                formMessage.textContent = '';
                formMessage.className = 'message';

                const dob = document.getElementById('dob').value;
                const fullName = document.getElementById('fullName').value.trim();
                const pekerjaan = document.getElementById('pekerjaan').value.trim();

                if (!fullName || !dob || !pekerjaan) {
                    showMessage('Nama, Tanggal Lahir, dan Pekerjaan wajib diisi.', 'error');
                    return;
                }

                const birthDate = new Date(dob);
                const age = new Date().getFullYear() - birthDate.getFullYear();

                let m = 0;
                if (age <= 20) m = 0.1;
                else if (age > 20 && age <= 35) m = 0.2;
                else if (age > 35 && age <= 50) m = 0.25;
                else if (age > 50) m = 0.4;
                
                const P = 2000000;
                let riskFactorSum = 0;
                
                selectedConditions.forEach(condition => {
                    riskFactorSum += (condition.factor * P);
                });

                const premiTahunan = P + (m * P) + riskFactorSum;

                premiumDisplay.innerHTML = `
                    <h3>Rp ${premiTahunan.toLocaleString('id-ID')}</h3>
                    <span>/ tahun</span>
                `;
                payBtn.classList.remove('disabled');

                sessionStorage.setItem('purchaseData', JSON.stringify({
                    product: 'Asuransi Kesehatan Ceria',
                    type: 'Kesehatan',
                    premium: premiTahunan
                }));
            });
            
            payBtn.addEventListener('click', function() {
                if (this.classList.contains('disabled')) return;
                const purchaseData = JSON.parse(sessionStorage.getItem('purchaseData'));
                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
                const history = JSON.parse(localStorage.getItem('purchaseHistory')) || [];
                history.push({
                    ...purchaseData,
                    date: new Date().toISOString(),
                    status: 'Lunas',
                    paymentMethod: paymentMethod
                });
                localStorage.setItem('purchaseHistory', JSON.stringify(history));
                alert('Pembayaran berhasil! Anda akan diarahkan ke halaman histori.');
                window.location.href = '../histori/histori.html';
            });
            
            function showMessage(msg, type) {
                formMessage.textContent = msg;
                formMessage.classList.add(type);
            }
        });
    </script>
</body>
</html>